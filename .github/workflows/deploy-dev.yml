name: Django App Pipeline

on:
  push:
    branches:
      - dev

env:
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
    
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: |
        docker build -t django_app:dev .

    - name: Push Docker image to registry
      run: |
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
        docker tag django_app:dev "$DOCKER_USER"/django_app:dev
        docker push "$DOCKER_USER"/django_app:dev

  deploy:
    runs-on: ubuntu-latest
    environment: dev
    needs: build
    steps:
    - name: Deploy Using SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: $SERVER_HOST
        username: $SERVER_USER
        key: $SERVER_SSH_KEY
        port: 22
        script: |
          sudo docker pull $DOCKER_USER/django_app:dev
          sudo docker service update --image $DOCKER_USER/django_app:dev afripoints
